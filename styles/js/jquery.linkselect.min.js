/*
 * Linkselect jQuery Plug-in
 *
 * Copyright 2013 Giva, Inc. (http://www.givainc.com/labs/) 
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * 	http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Date: 2013-08-29
 * Rev:  1.5.13
 */
(function(B){B.linkselect={version:"1.5.13"};B.fn.linkselect=function(F){var G=typeof arguments[0]=="string"&&arguments[0];var E=G&&Array.prototype.slice.call(arguments,1)||arguments;if(G&&this.length){var D=B.data(this[0],"linkselect");if(G.toLowerCase()=="object"){return D}else{if(D[G]){var C;this.each(function(H){var I=B.data(this,"linkselect")[G].apply(D,E);if(H==0&&I){if(!!I.jquery){C=B([]).add(I)}else{C=I;return false}}else{if(!!I&&!!I.jquery){C=C.add(I)}}});return C||this}else{return this}}}else{return this.each(function(){new B.LinkSelect(this,F)})}};var A=0;B.LinkSelect=function(u,W){W=B.extend({},B.LinkSelect.defaults,W);if(W.style.length==0){W.style=B.LinkSelect.defaults.style}W.classes={link:W.style+"-link",linkText:W.style+"-link-text",linkOpen:W.style+"-link-open",linkIcon:W.style+"-link-icon",linkFocus:W.style+"-link-focus",container:W.style+"-container",selected:W.style+"-selected",current:W.style+"-current",disabled:W.style+"-disabled",scrollable:W.style+"-scrollable",title:W.style+"-title",value:W.style+"-value",placeholder:"placeholder"};var K=this,L=++A,n=u,v=B(u),b={},e=false,O=0,d,G=false,c;this.id=v.attr("id");this.val=function(AA,z){if(arguments.length>0){o(AA,z);return N}else{return f.val()}};this.text=function(){return V().find("span."+W.classes.value).text()};this.change=function(){V().trigger("click.linkselect",[true,true]);return N};this.focus=function(){setTimeout(function(){N.focus()},1);return N};this.blur=function(){setTimeout(function(){N.blur()},1);return N};this.open=function(AA,z){if(e){return N}B(document).triggerHandler("click.linkselect");if(z!==false){N.trigger("focus")}setTimeout(function(){m(AA)},1);return N};this.disable=function(z){e=z;N.parent().find("span."+W.classes.disabled).remove();N[e?"hide":"show"]();if(e){N.after('<span class="'+W.classes.disabled+'">'+N.html()+"</span>")}return N};this.destroy=function(){X.undelegate("li","*");N.unbind("*");s();N.before(v);h.remove()};this.replaceOptions=function(AB,AD,AC){var z=(typeof AD==="string");if(!z&&!AC){AC=AD}var AA=v.children("option");if(z&&AD.length){AA=AA.not(AD)}AA.remove();B.each(AB,function(AE){var AF=B("<option/>").attr("value",this.value).html(this.text);if(this.selected==true){AF.attr("selected","selected")}if(this.className){AF.addClass(this.className)}AF.appendTo(v)});R();V().trigger("click.linkselect",[true,AC])};var q;function g(z,AA){f.val(z);y.html(AA);f.triggerHandler("update",[z,AA,K]);v.triggerHandler("update",[z,AA,K]);q=z}var h=w();v.after(h).remove();var f=h.filter("input"),N=h.filter("a"),y=N.find("> span."+W.classes.linkText),I=h.filter("div"),S=h.find("."+W.classes.scrollable),J=h.find("."+W.classes.title),X=I.find("ul"),Z;T();f.addClass(v.attr("class"));B.data(f[0],"linkselect",this);I.appendTo("body").bind("mousemove.linkselect",function(z){Z=z});X.delegate("li","mouseover.linkselect",function(z){if(Z&&Z.type=="keydown"){return }k(B(this));Z=z}).delegate("li","click.linkselect",function(AF,AA,AE){AF.preventDefault();var z=E(q).removeClass(W.classes.selected),AB=B(this).addClass(W.classes.selected),AD=AB.attr("data-value")||"",AG=AB.find("."+W.classes.value).html(),AC={value:(q||""),text:z.find("."+W.classes.value).html()};H(AA);g(AD,AG);if((AE!==false)&&((B.isFunction(W.change)&&(W.change.apply(K,[this,AD,AG,AE])===false))||(B.isFunction(v[0].onchange)&&(v[0].onchange.apply(K,[this,AD,AG,AE])===false)))){z.addClass(W.classes.selected);AB.removeClass(W.classes.selected);g(AC.value,AC.text);return }N[(AA!==true)?"trigger":"triggerHandler"]("focus",[AA]);if(e){N.parent().find("span."+W.classes.disabled).html(AG)}});N.bind("click.linkselect",function(z){z.preventDefault();l();setTimeout(function(){N.trigger("focus.linkselect")},0)}).bind("focus.linkselect",function(AA,z){if(!I.is(":visible")&&(z!==true)){N.addClass(W.classes.linkFocus)}}).bind("blur.linkselect",function(z){if(x(z)){H()}N.removeClass(W.classes.linkFocus)}).bind((B.browser.safari?"keydown":"keypress")+".linkselect",function(AE,AD){if(!!AD){var AE=AD}var AA=AE.keyCode||AE.charCode,AC=String.fromCharCode(AA).toLowerCase();switch(AA){case 38:case 40:AE.preventDefault();i((AA==38)?-1:1,true);Z=AE;break;case 13:AE.preventDefault();if(I.is(":visible")){I.find("li."+W.classes.current).trigger("click.linkselect")}else{N.trigger("click.linkselect")}break;case 9:case 27:H();break;case 35:AE.preventDefault();P();Z=AE;break;case 36:AE.preventDefault();a();Z=AE;break;case 33:case 34:AE.preventDefault();var z=I.is(":visible");if(!z){I.show()}var AB=parseInt(S.height()/X.find("li:not(."+W.classes.placeholder+"):first").outerHeight(),10);if(!z){I.hide()}i(AB*((AA==33)?-1:1));break}if(AC!=d){O=0}d=AC;if(typeof b[AC]!="undefined"){if(O>=b[AC].length){O=0}X.find("#"+K.id+"_li_"+b[AC][O]).trigger("click.linkselect");AE.preventDefault();AE.stopPropagation();O++}});if(B.browser.msie){N.bind("keydown.linkselect",function(z){if(",8,9,33,34,35,36,37,38,39,40,".indexOf(","+z.keyCode+",")>-1){return B(this).triggerHandler("keypress.linkselect",[z])}})}function U(){B(document).bind("click.linkselect-"+L,function(AA){var AB=B(AA.target);if((AB.closest("a")[0]!==N[0])&&(AB[0]!==S[0])&&I.is(":visible")){H();if(c&&(AB.closest("."+W.classes.title)[0]===J[0])){M()}var z=AB.closest(I);if(z.length){setTimeout(function(){N.trigger("focus.linkselect")},13)}else{N.removeClass(W.classes.linkFocus)}}});B(window).bind("resize.linkselect-"+L,function(){Q(N,I)})}function s(){B(document).unbind("click.linkselect-"+L);B(window).unbind("resize.linkselect-"+L)}function w(){var AE=K.id,AA=v.attr("name")||AE,AD=n.selectedIndex==-1?"":n[n.selectedIndex].text,AC=n.selectedIndex==-1?"":n[n.selectedIndex][(B.browser.msie&&B.browser.version<=7&&!(n[n.selectedIndex].attributes.value.specified))?"text":"value"],AB=v.attr("tabindex");var z=['<a href="#'+K.id+'" id="'+K.id+'_link" class="'+B.trim(W.classes.link+" "+W.classLink)+'"'+(AB?' tabindex="'+AB+'"':"")+">",'<span class="'+W.classes.linkText+'">',AD,"</span>",'<span class="'+W.classes.linkIcon+'"><span></span></span>',"</a>",'<input type="hidden" name="'+AA+'" id="'+K.id+'" value="'+AC+'" />','<div class="'+W.classes.container+'">','<div class="'+W.classes.title+'"><span></span></div>','<div class="'+W.classes.scrollable+'"><ul id="'+K.id+'_list">',p(v.children("option")),"</ul></div>","</div>"];return B(z.join(""))}function p(z){b=[],c=z.filter("."+W.classes.placeholder).eq(0);if(c.length==0){c=null}var AA=[];z.each(function(AD){var AH=B(this);var AF=AH.is(":selected");var AB=B.trim(AH.text());var AC='<span class="'+W.classes.value+'">'+AB+"</span>";var AG=B.browser.msie&&B.browser.version<=7&&!(this.attributes.value.specified)?this.text:this.value;if(B.isFunction(W.format)){AC=W.format.apply(K,[AC,AG,AB,AD,AH,W])||AC}if(!c||c[0]!==AH[0]){var AE=(AB.length>1)?AB.substring(0,1).toLowerCase():"";if(!b[AE]){b[AE]=[]}b[AE].push(AD)}var AI=B.trim(this.className+" "+(AF?W.classes.selected:""));AA.push('<li id="'+K.id+"_li_"+AD+'" data-value="'+AG+(AI.length>0?'" class="'+AI:"")+'">'+AC+"</li>")});return AA.join("")}function R(){F=false;I[0].style.width="";if(J.length){J[0].style.width="";J.css("float","")}X.html(p(v.children("option")));if(c){T()}}function T(){var z=B.trim(v.attr("title")||(c&&c.text())||"");J[z.length?"show":"hide"]()[c?"addClass":"removeClass"](W.classes.placeholder).find("span").text(z)}function M(){if(c){X.find("li."+W.classes.placeholder).trigger("click.linkselect")}}function E(z){return X.find("li[data-value='"+(z||"")+"']")}function o(AB,AA){var z=E(AB);if(z.length==0){z=X.find("li:eq(0)")}return z.trigger("click.linkselect",[true,AA])}function V(){var z=X.find("li."+W.classes.selected);if(z.length==0){z=X.find("li:eq(0)")}return z}function Y(){var z=X.find("li."+W.classes.current);if(z.length==0){z=V()}return z}function k(z){I.find("."+W.classes.current).removeClass(W.classes.current);return r(z)}function r(z){z.addClass(W.classes.current);if(c){J[z.hasClass(W.classes.placeholder)?"addClass":"removeClass"](W.classes.current)}return z}function i(AA,AB){var z=Y();var AC=parseInt(z.attr("id").replace(/(.+)(_(\d+$))/gi,"$3"),10);if(c&&(AB!==true)&&z.hasClass(W.classes.placeholder)){AC++}D(AC+AA,AB)}function D(AD,AB){var AC=I.find("li"),z;if(!AC||AC.length==0){return false}var AA=Y().removeClass(W.classes.current);if(isNaN(AD)||AD<0){AD=0}else{if(AD>AC.length-1){AD=AC.length-1}}z=AC.eq(AD);if(c&&(AB!==true)&&z.hasClass(W.classes.placeholder)){z=AC.eq(AD+1)}if(I.is(":visible")){r(z);C(z)}else{if(AA[0]!==z[0]){z.trigger("click.linkselect")}}}function a(){D(0)}function P(){D(I.find("li").length-1)}function C(AA,z){var AC=AA[0];var AD=S[0];var AB={pTop:parseInt(S.css("paddingTop"),10)||0,pBottom:parseInt(S.css("paddingBottom"),10)||0,bTop:parseInt(S.css("borderTopWidth"),10)||0,bBottom:parseInt(S.css("borderBottomWidth"),10)||0};if((AC.offsetTop+AC.offsetHeight)>(AD.scrollTop+AD.clientHeight)){AD.scrollTop=AA.offset().top+(AD.scrollTop-S.offset().top)-((AD.clientHeight/((z==true)?2:1))-(AA.outerHeight()+AB.pBottom))}else{if(AC.offsetTop-AB.bTop-AB.bBottom<=(AD.scrollTop+AB.pTop+AB.pBottom)){AD.scrollTop=AA.offset().top+(AD.scrollTop-S.offset().top)-AB.pTop}}}function l(){var z=I.is(":visible");if(z){H()}else{m()}return z}var F=false;function m(AG){U();var AB=V(),AA=!F;N.removeClass(W.classes.linkFocus).addClass(W.classes.linkOpen);I.show();if(!F){var AF=(N.css("display").indexOf("inline")>-1)?N.parent().outerWidth(true):N.outerWidth(true);var AC=W.fixedWidth?AF:I.outerWidth(true);if(AC<AF){AC=AF}var AE=parseInt(S.css("max-height"),10);if(B.browser.msie&&B.browser.version<=6){if((AE>0)&&(S.height()>AE)){S.height(AE)}}if(X.height()>AE){AC+=25}var AD=parseInt("0"+I.css("max-width"),10);if((AD>0)&&(AC>AD)){AC=AF=AD}I.width(AC);if(B.browser.safari){var z=I.width();if(AF>z){AC=AF=z}}AF=AF-((parseInt(J.css("marginRight"),10)||0)-(parseInt(J.css("marginLeft"),10)||0));J.width(AF);if(J.outerWidth()>AF){J.width(AF-(J.outerWidth()-AF))}if(W.titleAlign.toLowerCase()=="right"&&!W.fixedWidth){J.css("float","right")}F=true}Q(N,I,AA);if(!!B.fn.bgIframe){I.bgIframe()}C(AB,true);k(AB);if(B.isFunction(W.open)){W.open.apply(this,[I,N,AB,J])}if(B.isFunction(AG)){AG.apply(this,[I,N,AB,J])}G=true}function H(z){s();if(z!==true){N.addClass(W.classes.linkFocus).removeClass(W.classes.linkOpen)}I.hide();if(B.isFunction(W.close)){W.close.apply(this,[I,N,V(),J])}G=false}function j(z){var AA=false;if(z.is(":hidden")){AA=!!z.css("visibility","hidden").show()}var AB=B.extend(z.offset(),{width:z.outerWidth(),height:z.outerHeight(),marginLeft:parseInt(B.curCSS(z[0],"marginLeft",true),10)||0,marginRight:parseInt(B.curCSS(z[0],"marginRight",true),10)||0,marginTop:parseInt(B.curCSS(z[0],"marginTop",true),10)||0,marginBottom:parseInt(B.curCSS(z[0],"marginBottom",true),10)||0,paddingLeft:parseInt(B.curCSS(z[0],"paddingLeft",true),10)||0,paddingRight:parseInt(B.curCSS(z[0],"paddingRight",true),10)||0,borderLeftWidth:parseInt(B.curCSS(z[0],"borderLeftWidth",true),10)||0,borderRightWidth:parseInt(B.curCSS(z[0],"borderRightWidth",true),10)||0});if(AB.marginTop<0){AB.top+=AB.marginTop}if(AB.marginLeft<0){AB.left+=AB.marginLeft}AB.bottom=AB.top+AB.height;AB.right=AB.left+AB.width;if(AA){z.hide().css("visibility","visible")}return AB}function Q(AH,z,AC){var AE=j(AH);var AB=t();var AG=I.outerWidth()+AE.left;if(AG>AB.x){var AD=AE.paddingLeft+AE.paddingRight+AE.borderLeftWidth+AE.borderRightWidth;if(AC){J.width(J.width()-AD)}AE.left=(AE.left+AD-I.outerWidth())+J.outerWidth(true)}else{var AF=I.width(),AA=J.outerWidth(true);if(AF>AA){J.width(AF-(AA-J.width()))}}z.css({position:"absolute",top:AE[W.yAxis],left:AE.left});return AE.bottom}function t(){var z={scrollLeft:B(window).scrollLeft(),scrollTop:B(window).scrollTop(),width:B("body").width(),height:B("body").height()};z.x=z.scrollLeft+z.width;z.y=z.scrollTop+z.height;return z}function x(z){return !("bubbles" in z||"cancelBubble" in z)}this.$select=v;this.$input=f;this.$container=I;q=this.val();if(B.isFunction(W.init)){W.init.apply(this,[v,f,N,I,S,J,X])}};B.LinkSelect.defaults={style:"linkselect",classLink:"",yAxis:"top",titleAlign:"right",fixedWidth:false,init:null,change:null,format:null,open:null,close:null}})(jQuery);